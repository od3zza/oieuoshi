name: Save Comment

on:
  workflow_dispatch:
    inputs:
      postId:
        description: "ID do post"
        required: true
      nome:
        description: "Nome do usuário"
        required: true
      mensagem:
        description: "Mensagem"
        required: true

jobs:
  save:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Add comment
        run: |
          FILE=data/comentarios.json
          TEMP=temp.json
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Escapa caracteres especiais
          SAFE_NOME=$(echo "${{ github.event.inputs.nome }}" | jq -R .)
          SAFE_MSG=$(echo "${{ github.event.inputs.mensagem }}" | jq -R .)
          SAFE_POST=$(echo "${{ github.event.inputs.postId }}" | jq -R .)

          # Monta o objeto do comentário
          COMMENT=$(jq -n \
            --arg postId "${{ github.event.inputs.postId }}" \
            --arg nome "${{ github.event.inputs.nome }}" \
            --arg mensagem "${{ github.event.inputs.mensagem }}" \
            --arg data "$DATE" \
            '{postId: $postId, nome: $nome, mensagem: $mensagem, data: $data}')

          # Atualiza o JSON
          jq ". += [$COMMENT]" $FILE > $TEMP && mv $TEMP $FILE

      - name: Commit changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add data/comentarios.json
          git commit -m "Adiciona comentário"
          git push
